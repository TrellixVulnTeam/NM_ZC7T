import { Injectable } from '@angular/core';
import { BehaviorSubject, of } from 'rxjs';
import { SfMenuService } from '@safe-fleet/sf-menu';
import { EventTypeEnum } from '../../interfaces/IMenuConfig';
import { SecurityService } from '../security/security.service';
import { catchError, map, mergeMap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@safe-fleet/sf-menu";
import * as i2 from "../security/security.service";
export class SfSecurityMenuService {
    constructor(sfMenuService, securityService) {
        this.sfMenuService = sfMenuService;
        this.securityService = securityService;
        this.infoMessageVisibilityChange = new BehaviorSubject(false);
        this.events$ = this.sfMenuService.events$;
    }
    configureMenu(config, securityInfo) {
        this.securityService.setSecurityInformation(securityInfo.securityEndpoint, securityInfo.settingsEndpoint, securityInfo.headers);
        this.refreshMenu(config);
        this.onMenuChanges();
        this.infoMessageVisibilityChange.next(false);
        this.unauthorizedPopup = this.getUnauthorizedPopup(config.unauthorizedPopup);
        const permissionsObservable = this.securityService.getSecurityPermissions(config.currentProduct.id).pipe(catchError((error) => {
            if (error.status === 403 && config.multipleTenants && config.unauthorizedPopup) {
                this.infoMessageVisibilityChange.next(true);
            }
            throw error;
        }));
        const applicationsObservable = this.securityService.getApplications().pipe(map((applications) => this.mapConfiguration(config, applications, securityInfo)), catchError((error) => {
            this.refreshMenu(config);
            throw error;
        }));
        const applicationInfoObservable = this.securityService.getApplicationInfo();
        return applicationsObservable.pipe(mergeMap(() => permissionsObservable), mergeMap(() => applicationInfoObservable), catchError(() => of('')));
    }
    refreshMenu(config) {
        this.sfMenuService.setMenuConfig(config);
    }
    getPermissions() {
        return this.securityService.getPermissions();
    }
    getSettingsInfo() {
        return this.securityService.getInfo();
    }
    mapConfiguration(config, applications, securityInfo) {
        config.products = [];
        const menuItems = [];
        applications.forEach((app) => {
            menuItems.push(this.mapMenuApplication(app));
        });
        const selectedProduct = menuItems.find((app) => app.text === securityInfo.selectedApplication);
        if (!selectedProduct || selectedProduct === null) {
            config.products = menuItems;
            this.refreshMenu(config);
            return;
        }
        config.currentProduct = selectedProduct;
        config.products = menuItems.filter((item) => item.id !== config.currentProduct.id);
        this.refreshMenu(config);
    }
    mapMenuApplication(app) {
        return {
            text: app.applicationName,
            routeHref: app.applicationUrl,
            iconPath: app.applicationIconUrl,
            id: app.applicationName,
            newWindow: false,
            active: false,
            expanded: false,
            newTab: false,
        };
    }
    getUnauthorizedPopup(popupConfig) {
        return {
            popupButtonText: popupConfig ? popupConfig.popupButtonText : '',
            popupMessageActionText: popupConfig ? popupConfig.popupMessageActionText : '',
            popupMessageText: popupConfig ? popupConfig.popupMessageText : '',
        };
    }
    reloadPermissions(applicationName) {
        return this.securityService.getSecurityPermissions(applicationName);
    }
    onMenuChanges() {
        return this.sfMenuService.events$.subscribe((menuEvent) => {
            if (menuEvent.type === EventTypeEnum.OpenTenantListClick) {
                this.infoMessageVisibilityChange.next(false);
            }
        });
    }
}
SfSecurityMenuService.ɵprov = i0.ɵɵdefineInjectable({ factory: function SfSecurityMenuService_Factory() { return new SfSecurityMenuService(i0.ɵɵinject(i1.SfMenuService), i0.ɵɵinject(i2.SecurityService)); }, token: SfSecurityMenuService, providedIn: "root" });
SfSecurityMenuService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
SfSecurityMenuService.ctorParameters = () => [
    { type: SfMenuService },
    { type: SecurityService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Ytc2VjdXJpdHktbWVudS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvc2Ytc2VjdXJpdHktbWVudS9zcmMvbGliL3NlcnZpY2VzL3NmLXNlY3VyaXR5LW1lbnUvc2Ytc2VjdXJpdHktbWVudS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGVBQWUsRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRXBELE9BQU8sRUFBRSxhQUFhLEVBQTZELE1BQU0sOEJBQThCLENBQUM7QUFDeEgsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBSzNELE1BQU0sT0FBTyxxQkFBcUI7SUFJaEMsWUFBNkIsYUFBNEIsRUFBbUIsZUFBZ0M7UUFBL0Usa0JBQWEsR0FBYixhQUFhLENBQWU7UUFBbUIsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBSDVHLGdDQUEyQixHQUE2QixJQUFJLGVBQWUsQ0FBVSxLQUFLLENBQUMsQ0FBQztRQUU1RixZQUFPLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUM7SUFDMEUsQ0FBQztJQUV6RyxhQUFhLENBQUMsTUFBbUIsRUFBRSxZQUEyQjtRQUNuRSxJQUFJLENBQUMsZUFBZSxDQUFDLHNCQUFzQixDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsRUFBRSxZQUFZLENBQUMsZ0JBQWdCLEVBQUUsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2hJLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDekIsSUFB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Q3hELElBQUksQ0FBQywyQkFBMkIsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDOUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Ozs7WUFuR0YsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7WUFSUSxhQUFhO1lBR2IsZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFNmTWVudVNlcnZpY2UgfSBmcm9tICdAc2FmZS1mbGVldC9zZi1tZW51JztcbmltcG9ydCB7IElBcHBsaWNhdGlvbiB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvSUFwcGxpY2F0aW9uJztcbmltcG9ydCB7IEV2ZW50VHlwZUVudW0sIElNZW51Q29uZmlnLCBJTWVudUl0ZW0sIElTZWN1cml0eUluZm8sIElVbmF1dGhvcml6ZWRQb3B1cCB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvSU1lbnVDb25maWcnO1xuaW1wb3J0IHsgU2VjdXJpdHlTZXJ2aWNlIH0gZnJvbSAnLi4vc2VjdXJpdHkvc2VjdXJpdHkuc2VydmljZSc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBtYXAsIG1lcmdlTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgU2ZTZWN1cml0eU1lbnVTZXJ2aWNlIHtcbiAgaW5mb01lc3NhZ2VWaXNpYmlsaXR5Q2hhbmdlOiBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KGZhbHNlKTtcbiAgdW5hdXRob3JpemVkUG9wdXA6IElVbmF1dGhvcml6ZWRQb3B1cDtcbiAgZXZlbnRzJCA9IHRoaXMuc2ZNZW51U2VydmljZS5ldmVudHMkO1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHNmTWVudVNlcnZpY2U6IFNmTWVudVNlcnZpY2UsIHByaXZhdGUgcmVhZG9ubHkgc2VjdXJpdHlTZXJ2aWNlOiBTZWN1cml0eVNlcnZpY2UpIHt9XG5cbiAgcHVibGljIGNvbmZpZ3VyZU1lbnUoY29uZmlnOiBJTWVudUNvbmZpZywgc2VjdXJpdHlJbmZvOiBJU2VjdXJpdHlJbmZvKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICB0aGlzLnNlY3VyaXR5U2VydmljZS5zZXRTZWN1cml0eUluZm9ybWF0aW9uKHNlY3VyaXR5SW5mby5zZWN1cml0eUVuZHBvaW50LCBzZWN1cml0eUluZm8uc2V0dGluZ3NFbmRwb2ludCwgc2VjdXJpdHlJbmZvLmhlYWRlcnMpO1xuICAgIHRoaXMucmVmcmVzaE1lbnUoY29uZmlnKTtcbiAgICB0aGlzLm9uTWVudUNoYW5nZXMoKTtcbiAgICB0aGlzLmluZm9NZXNzYWdlVmlzaWJpbGl0eUNoYW5nZS5uZXh0KGZhbHNlKTtcbiAgICB0aGlzLnVuYXV0aG9yaXplZFBvcHVwID0gdGhpcy5nZXRVbmF1dGhvcml6ZWRQb3B1cChjb25maWcudW5hdXRob3JpemVkUG9wdXApO1xuICAgIGNvbnN0IHBlcm1pc3Npb25zT2JzZXJ2YWJsZSA9IHRoaXMuc2VjdXJpdHlTZXJ2aWNlLmdldFNlY3VyaXR5UGVybWlzc2lvbnMoY29uZmlnLmN1cnJlbnRQcm9kdWN0LmlkKS5waXBlKFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3IpID0+IHtcbiAgICAgICAgaWYgKGVycm9yLnN0YXR1cyA9PT0gNDAzICYmIGNvbmZpZy5tdWx0aXBsZVRlbmFudHMgJiYgY29uZmlnLnVuYXV0aG9yaXplZFBvcHVwKSB7XG4gICAgICAgICAgdGhpcy5pbmZvTWVzc2FnZVZpc2liaWxpdHlDaGFuZ2UubmV4dCh0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIGNvbnN0IGFwcGxpY2F0aW9uc09ic2VydmFibGUgPSB0aGlzLnNlY3VyaXR5U2VydmljZS5nZXRBcHBsaWNhdGlvbnMoKS5waXBlKFxuICAgICAgbWFwKChhcHBsaWNhdGlvbnM6IElBcHBsaWNhdGlvbltdKSA9PiB0aGlzLm1hcENvbmZpZ3VyYXRpb24oY29uZmlnLCBhcHBsaWNhdGlvbnMsIHNlY3VyaXR5SW5mbykpLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3IpID0+IHtcbiAgICAgICAgdGhpcy5yZWZyZXNoTWVudShjb25maWcpO1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIGNvbnN0IGFwcGxpY2F0aW9uSW5mb09ic2VydmFibGUgPSB0aGlzLnNlY3VyaXR5U2VydmljZS5nZXRBcHBsaWNhdGlvbkluZm8oKTtcbiAgICByZXR1cm4gYXBwbGljYXRpb25zT2JzZXJ2YWJsZS5waXBlKFxuICAgICAgbWVyZ2VNYXAoKCkgPT4gcGVybWlzc2lvbnNPYnNlcnZhYmxlKSxcbiAgICAgIG1lcmdlTWFwKCgpID0+IGFwcGxpY2F0aW9uSW5mb09ic2VydmFibGUpLFxuICAgICAgY2F0Y2hFcnJvcigoKSA9PiBvZignJykpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyByZWZyZXNoTWVudShjb25maWc6IElNZW51Q29uZmlnKSB7XG4gICAgdGhpcy5zZk1lbnVTZXJ2aWNlLnNldE1lbnVDb25maWcoY29uZmlnKTtcbiAgfVxuICBwdWJsaWMgZ2V0UGVybWlzc2lvbnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuc2VjdXJpdHlTZXJ2aWNlLmdldFBlcm1pc3Npb25zKCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0U2V0dGluZ3NJbmZvKCkge1xuICAgIHJldHVybiB0aGlzLnNlY3VyaXR5U2VydmljZS5nZXRJbmZvKCk7XG4gIH1cblxuICBwcml2YXRlIG1hcENvbmZpZ3VyYXRpb24oY29uZmlnOiBJTWVudUNvbmZpZywgYXBwbGljYXRpb25zOiBJQXBwbGljYXRpb25bXSwgc2VjdXJpdHlJbmZvOiBJU2VjdXJpdHlJbmZvKSB7XG4gICAgY29uZmlnLnByb2R1Y3RzID0gW107XG4gICAgY29uc3QgbWVudUl0ZW1zOiBJTWVudUl0ZW1bXSA9IFtdO1xuICAgIGFwcGxpY2F0aW9ucy5mb3JFYWNoKChhcHApID0+IHtcbiAgICAgIG1lbnVJdGVtcy5wdXNoKHRoaXMubWFwTWVudUFwcGxpY2F0aW9uKGFwcCkpO1xuICAgIH0pO1xuICAgIGNvbnN0IHNlbGVjdGVkUHJvZHVjdCA9IG1lbnVJdGVtcy5maW5kKChhcHApID0+IGFwcC50ZXh0ID09PSBzZWN1cml0eUluZm8uc2VsZWN0ZWRBcHBsaWNhdGlvbik7XG4gICAgaWYgKCFzZWxlY3RlZFByb2R1Y3QgfHwgc2VsZWN0ZWRQcm9kdWN0ID09PSBudWxsKSB7XG4gICAgICBjb25maWcucHJvZHVjdHMgPSBtZW51SXRlbXM7XG4gICAgICB0aGlzLnJlZnJlc2hNZW51KGNvbmZpZyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbmZpZy5jdXJyZW50UHJvZHVjdCA9IHNlbGVjdGVkUHJvZHVjdDtcbiAgICBjb25maWcucHJvZHVjdHMgPSBtZW51SXRlbXMuZmlsdGVyKChpdGVtKSA9PiBpdGVtLmlkICE9PSBjb25maWcuY3VycmVudFByb2R1Y3QuaWQpO1xuICAgIHRoaXMucmVmcmVzaE1lbnUoY29uZmlnKTtcbiAgfVxuXG4gIHByaXZhdGUgbWFwTWVudUFwcGxpY2F0aW9uKGFwcDogSUFwcGxpY2F0aW9uKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRleHQ6IGFwcC5hcHBsaWNhdGlvbk5hbWUsXG4gICAgICByb3V0ZUhyZWY6IGFwcC5hcHBsaWNhdGlvblVybCxcbiAgICAgIGljb25QYXRoOiBhcHAuYXBwbGljYXRpb25JY29uVXJsLFxuICAgICAgaWQ6IGFwcC5hcHBsaWNhdGlvbk5hbWUsXG4gICAgICBuZXdXaW5kb3c6IGZhbHNlLFxuICAgICAgYWN0aXZlOiBmYWxzZSxcbiAgICAgIGV4cGFuZGVkOiBmYWxzZSxcbiAgICAgIG5ld1RhYjogZmFsc2UsXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VW5hdXRob3JpemVkUG9wdXAocG9wdXBDb25maWc6IElVbmF1dGhvcml6ZWRQb3B1cCk6IElVbmF1dGhvcml6ZWRQb3B1cCB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHBvcHVwQnV0dG9uVGV4dDogcG9wdXBDb25maWcgPyBwb3B1cENvbmZpZy5wb3B1cEJ1dHRvblRleHQgOiAnJyxcbiAgICAgIHBvcHVwTWVzc2FnZUFjdGlvblRleHQ6IHBvcHVwQ29uZmlnID8gcG9wdXBDb25maWcucG9wdXBNZXNzYWdlQWN0aW9uVGV4dCA6ICcnLFxuICAgICAgcG9wdXBNZXNzYWdlVGV4dDogcG9wdXBDb25maWcgPyBwb3B1cENvbmZpZy5wb3B1cE1lc3NhZ2VUZXh0IDogJycsXG4gICAgfSBhcyBJVW5hdXRob3JpemVkUG9wdXA7XG4gIH1cblxuICBwdWJsaWMgcmVsb2FkUGVybWlzc2lvbnMoYXBwbGljYXRpb25OYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLnNlY3VyaXR5U2VydmljZS5nZXRTZWN1cml0eVBlcm1pc3Npb25zKGFwcGxpY2F0aW9uTmFtZSk7XG4gIH1cblxuICBwcml2YXRlIG9uTWVudUNoYW5nZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuc2ZNZW51U2VydmljZS5ldmVudHMkLnN1YnNjcmliZSgobWVudUV2ZW50KSA9PiB7XG4gICAgICBpZiAobWVudUV2ZW50LnR5cGUgPT09IEV2ZW50VHlwZUVudW0uT3BlblRlbmFudExpc3RDbGljaykge1xuICAgICAgICB0aGlzLmluZm9NZXNzYWdlVmlzaWJpbGl0eUNoYW5nZS5uZXh0KGZhbHNlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuIl19